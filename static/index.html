<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Real-Time SMTP Dashboard</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 16px; }
    #counters { display:flex; gap:20px; margin-bottom:20px; }
    .card { padding:12px; border:1px solid #ddd; border-radius:6px; min-width: 180px; }
    #charts { display:flex; gap:20px; }
    canvas { background:#fff; border:1px solid #eee; }
    #events { margin-top:20px; max-height: 300px; overflow:auto; border:1px solid #eee; padding:8px; }
    .evt { border-bottom:1px solid #f0f0f0; padding:6px 0; font-size:13px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Real-Time SMTP Dashboard</h1>

  <div id="counters">
    <div class="card">
      <h3>Total emails</h3>
      <div id="total" style="font-size:24px">0</div>
    </div>
    <div class="card">
      <h3>Spam count</h3>
      <div id="spam" style="font-size:24px; color:crimson">0</div>
    </div>
    <div class="card">
      <h3>SMTP Status</h3>
      <div id="smtp_status">stopped</div>
      <div id="smtp_info" style="font-size:12px;color:#666"></div>
    </div>
  </div>

  <div id="charts">
    <div style="flex:1">
      <h4>Spam vs Ham</h4>
      <canvas id="pieChart" width="300" height="200"></canvas>
    </div>
    <div style="flex:1">
      <h4>Top Sender Domains</h4>
      <canvas id="barChart" width="300" height="200"></canvas>
    </div>
  </div>

  <h4>Recent Events</h4>
  <div id="events"></div>

  <script>
    const wsUrl = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';
    const ws = new WebSocket(wsUrl);

    const totalEl = document.getElementById('total');
    const spamEl = document.getElementById('spam');
    const smtpStatusEl = document.getElementById('smtp_status');
    const smtpInfoEl = document.getElementById('smtp_info');
    const eventsEl = document.getElementById('events');

    let total = 0, spam = 0;

    // Chart.js setup
    const pieCtx = document.getElementById('pieChart').getContext('2d');
    const pieChart = new Chart(pieCtx, {
      type: 'pie',
      data: {
        labels: ['Ham', 'Spam'],
        datasets: [{ data: [1,0], backgroundColor: ['#36a2eb','#ff6384'] }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });

    const barCtx = document.getElementById('barChart').getContext('2d');
    const barChart = new Chart(barCtx, {
      type: 'bar',
      data: { labels: [], datasets: [{ label: 'Emails', data: [], backgroundColor: '#4caf50' }] },
      options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false }
    });

    function updateCharts(summary) {
      total = summary.total_emails || 0;
      spam = summary.spam_count || 0;
      totalEl.textContent = total;
      spamEl.textContent = spam;

      // pie
      const ham = Math.max(0, total - spam);
      pieChart.data.datasets[0].data = [ham, spam];
      pieChart.update();

      // bar (top domains)
      const top = summary.top_domains || [];
      barChart.data.labels = top.map(t => t.domain);
      barChart.data.datasets[0].data = top.map(t => t.count);
      barChart.update();

      // smtp status
      const st = summary.smtp_status || {};
      smtpStatusEl.textContent = st.listening ? 'listening' : 'stopped';
      smtpInfoEl.textContent = st.listening ? `${st.host}:${st.port}` : '';
    }

    ws.addEventListener('open', () => {
      console.log('ws open');
    });

    ws.addEventListener('message', (ev) => {
      try {
        const obj = JSON.parse(ev.data);
        if (obj.type === 'init' || obj.type === 'status') {
          updateCharts(obj.summary);
        } else if (obj.type === 'email_event') {
          updateCharts(obj.summary);
          prependEvent(obj.event);
        }
      } catch (e) {
        console.error('ws message parse error', e);
      }
    });

    ws.addEventListener('close', () => {
      console.warn('ws closed');
    });

    // Keep alive - send a ping every 25s to avoid connection closing by some proxies
    setInterval(() => {
      if (ws.readyState === WebSocket.OPEN) {
        try { ws.send(JSON.stringify({type:'ping', time: Date.now()})); } catch (e) {}
      }
    }, 25000);

    function prependEvent(event) {
      const div = document.createElement('div');
      div.className = 'evt';
      div.innerHTML = `<strong>[${new Date(event.time).toLocaleTimeString()}]</strong>
        ${event.is_spam ? '<span style="color:crimson">SPAM</span>' : '<span style="color:green">HAM</span>'}
        &nbsp; <em>${escapeHtml(event.subject || '(no subject)')}</em>
        <div style="font-size:12px;color:#666">${escapeHtml(event.from || '')} â†’ ${escapeHtml((event.to||[]).join(', '))} (score: ${Number(event.score).toFixed(2)})</div>`;
      eventsEl.insertBefore(div, eventsEl.firstChild);
    }

    function escapeHtml(s) {
      return String(s || '').replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];});
    }

    // optional: allow clicking on charts to drill down (left for you)
  </script>
</body>
</html>
